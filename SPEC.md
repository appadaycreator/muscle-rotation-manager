# 機能仕様書 (SPEC.md)

## アプリケーション概要

筋トレ部位ローテーション管理システムは、筋肉の回復期間を考慮した科学的なトレーニングスケジュール管理を行うWebアプリケーションです。

## 機能一覧

### 1. 認証・ユーザー管理
- **ユーザー登録**: メールアドレス・パスワードによる新規登録
- **ログイン**: メールアドレス・パスワードによる認証
- **プライバシーポリシー同意**: 新規登録時の必須同意項目
- **認証状態管理**: Supabaseによるセッション管理

### 2. ダッシュボード
- **ワークアウト概要表示**: 最新のトレーニング状況
- **今日の推奨部位**: 回復期間を考慮した最適な部位提案
- **統計情報**: 週間・月間のトレーニング実績

### 3. ワークアウト記録
- **トレーニング開始**: 新しいワークアウトセッションの開始
- **エクササイズ記録**: 種目、重量、回数、セット数の記録
- **タイマー機能**: ワークアウト時間の計測
- **部位選択**: 対象筋肉部位の指定

### 4. カレンダー
- **月間表示**: カレンダー形式でのトレーニング履歴表示
- **日別詳細**: 特定日のワークアウト詳細表示
- **色分け表示**: 部位別の色分けによる視覚化

### 5. 分析機能
- **パフォーマンス分析**: トレーニング成果の数値化
- **進捗グラフ**: 時系列でのパフォーマンス推移
- **部位別統計**: 各筋肉部位のトレーニング頻度・強度

### 6. エクササイズ管理
- **種目リスト**: 部位別エクササイズの一覧表示
- **種目詳細**: エクササイズの実行方法・注意点
- **カスタム追加**: ユーザー独自の種目登録

### 7. 設定
- **プロフィール編集**: ニックネーム、メールアドレス、アバター画像の変更
- **表示設定**: 言語、フォントサイズの変更
- **データ管理**: エクスポート・削除機能
- **プライバシーポリシー**: リンクによるポリシー表示

#### プロフィール編集の詳細仕様
- **ニックネーム**: 最大50文字、必須項目
- **メールアドレス**: 有効な形式、認証連携
- **アバター画像**: ファイルアップロード、プレビュー機能
- **エラーハンドリング**: 詳細なエラーメッセージ表示
- **デバッグログ**: コンソールでの詳細ログ出力

### 8. プライバシーポリシー
- **個人情報保護方針**: 詳細なプライバシーポリシーページ
- **データ取扱説明**: 収集データの用途・保管方法
- **ユーザー権利**: データ削除・修正の権利について
- **第三者サービス**: 利用サービスのプライバシー情報

## データ構造

### ユーザーテーブル
- id (UUID)
- email (string)
- nickname (string)
- created_at (timestamp)
- updated_at (timestamp)

### ワークアウトテーブル
- id (UUID)
- user_id (UUID)
- date (date)
- duration (integer)
- muscle_groups (array)
- created_at (timestamp)

### エクササイズテーブル
- id (UUID)
- workout_id (UUID)
- name (string)
- sets (integer)
- reps (integer)
- weight (decimal)
- muscle_group (string)

## セキュリティ仕様

### 認証
- Supabase Auth による OAuth2.0 準拠の認証
- JWTトークンによるセッション管理
- パスワードの暗号化保存

### データ保護
- HTTPS通信による暗号化
- RLS (Row Level Security) によるデータアクセス制御
- 個人情報の適切な匿名化

### プライバシー
- GDPR準拠のデータ保護
- ユーザー同意に基づくデータ収集
- データ削除権の実装

## 技術仕様

### フロントエンド
- HTML5, CSS3, JavaScript (ES6+)
- Tailwind CSS によるレスポンシブデザイン
- PWA対応 (Service Worker, Web App Manifest)

### バックエンド
- Supabase (PostgreSQL)
- リアルタイム更新対応
- RESTful API

### 外部サービス
- Google Analytics (アクセス解析)
- Google Tag Manager (タグ管理)
- CDN (ライブラリ配信)

### 自動化・CI/CD
- GitHub Actions (Supabaseキープアライブワークフロー)
- 日次スケジュール実行によるサービス稼働状態維持
- CI/CDパイプライン (プッシュ/プルリクエスト時の自動テスト)
- セキュリティ監査 (週次npm audit、Lighthouse CI)
- 依存関係脆弱性チェック

## テスト駆動開発環境

### テスト戦略
- **ユニットテスト**: 個別機能の単体テスト（筋肉部位管理、回復期間計算など）
- **統合テスト**: 機能間の連携テスト（ワークアウトフロー、データ永続化など）
- **仕様書駆動テスト**: SPEC.md準拠の要件検証テスト
- **E2Eテスト**: Puppeteerによるブラウザ自動化テスト

### テストフレームワーク
- **カスタムテストランナー**: 軽量なJavaScript製テストフレームワーク
- **モック機能**: Supabaseクライアントのモック実装
- **アサーション**: 豊富なアサーション関数（toBe, toEqual, toContain等）
- **非同期テスト**: Promise/async-await対応

### テスト実行環境
- **ブラウザテスト**: tests/test-runner.html でのインタラクティブ実行
- **Node.jsテスト**: コマンドラインでの自動実行
- **CI/CD統合**: GitHub Actionsでの自動テスト実行
- **結果出力**: JSON形式でのテスト結果保存

### テストカバレッジ対象
- **認証機能**: ユーザー登録、ログイン、セッション管理
- **ワークアウト記録**: セッション開始、エクササイズ記録、完了処理
- **筋肉部位管理**: 6部位選択、回復期間計算、推奨部位提案
- **ローテーション機能**: 2分割、3分割、4分割の提案
- **データ永続化**: Supabaseとの連携、CRUD操作
- **UI/UX**: レスポンシブデザイン、アクセシビリティ

## 最新更新履歴

### v1.6.0 (2025-01-23) - エラー修正とパフォーマンス最適化
- **修正**: Service Workerのchrome-extension スキームエラーを解決
- **修正**: アバター画像アップロード機能の完全実装
- **追加**: デフォルトアバター画像（PNG/SVG）の提供
- **改善**: Supabaseアバターアップロードのエラーハンドリング強化
- **最適化**: Promise.allSettledによる並列処理とエラー耐性向上
- **更新**: Service Workerキャッシュリストの最適化
- **達成**: リンターエラー0件、テスト成功率100%
- **達成**: 全59テストケースが成功（ユニット33、統合11、仕様15）
- **クリーンアップ**: 不要ファイル15件の削除とプロジェクト整理

### v1.5.0 (2025-01-23) - 大規模リファクタリング
- **リファクタリング**: 巨大なapp.jsファイル（2400行）を機能別モジュールに分割
- **追加**: ESLint・Prettierによるコード品質管理システム
- **改善**: モジュラー設計による保守性・拡張性の大幅向上
- **追加**: TypeScript風のJSDoc型注釈による型安全性向上
- **更新**: ES6+モジュール構文への完全移行
- **削除**: 不要ファイルのクリーンアップとプロジェクト整理
- **改善**: 関心の分離とシングルトンパターンによる設計最適化
- **追加**: サービス層とユーティリティ層の明確な分離

### v1.4.0 (2025-01-23)
- **修正**: ニックネーム設定エラーの解決
- **追加**: プロフィール保存・取得の詳細ログ機能
- **追加**: Supabase MCP統合とトラブルシューティング
- **更新**: エラーハンドリングの強化
- **更新**: README.mdにMCP設定手順追加
- **更新**: SPEC.mdにプロフィール編集詳細仕様追加

### v1.3.0 (2024-12-25)
- **追加**: テスト駆動開発環境の完全実装
- **追加**: カスタムテストランナー（軽量JavaScript製）
- **追加**: ユニットテスト（筋肉部位管理、回復期間計算）
- **追加**: 統合テスト（ワークアウトフロー、データ永続化）
- **追加**: 仕様書駆動テスト（SPEC.md準拠要件検証）
- **追加**: Supabaseモック実装（テスト用）
- **追加**: インタラクティブテストランナー（HTML UI）
- **追加**: テストテンプレート（新規テスト作成用）
- **更新**: package.jsonにテスト関連スクリプト追加
- **更新**: 技術仕様書にテスト戦略記載

### v1.2.0 (2024-12-25)
- **追加**: GitHub Actionsワークフロー実装
- **追加**: Supabaseキープアライブ自動化（日次実行）
- **追加**: CI/CDパイプライン（自動テスト実行）
- **追加**: セキュリティ監査ワークフロー（週次実行）
- **追加**: Lighthouse CI パフォーマンス監査
- **追加**: npm依存関係脆弱性チェック
- **更新**: package.jsonテストスクリプト設定
- **更新**: .gitignore設定（Node.js、テスト結果、スクリーンショットを除外）
- **更新**: 技術仕様書にCI/CD関連記載追加

### v1.1.0 (2024-12-25)
- **追加**: プライバシーポリシーページの実装
- **追加**: プライバシーポリシーへのナビゲーションリンク
- **追加**: 新規登録時のプライバシーポリシー同意チェックボックス
- **更新**: サイドバーメニューにプライバシーポリシーリンク追加
- **更新**: 設定ページにプライバシーポリシーリンク追加
- **更新**: README.md でのプライバシー情報記載

### v1.0.0 (2024-12-01)
- 初期リリース
- 基本機能の実装完了