<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase同期テスト - MuscleRotationManager</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen p-8">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-3xl font-bold text-gray-900 mb-8">Supabase同期テスト</h1>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- 接続状態 -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-wifi text-blue-500 mr-2"></i>
                        接続状態
                    </h2>
                    <div id="connection-status" class="space-y-2">
                        <div class="flex items-center">
                            <span class="w-3 h-3 bg-gray-400 rounded-full mr-2"></span>
                            <span>接続確認中...</span>
                        </div>
                    </div>
                </div>

                <!-- 認証状態 -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-user text-green-500 mr-2"></i>
                        認証状態
                    </h2>
                    <div id="auth-status" class="space-y-2">
                        <div class="flex items-center">
                            <span class="w-3 h-3 bg-gray-400 rounded-full mr-2"></span>
                            <span>認証確認中...</span>
                        </div>
                    </div>
                </div>

                <!-- データ保存テスト -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-save text-purple-500 mr-2"></i>
                        データ保存テスト
                    </h2>
                    <div class="space-y-4">
                        <button id="test-save" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                            テストデータを保存
                        </button>
                        <button id="test-load" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">
                            データを読み込み
                        </button>
                        <div id="save-result" class="text-sm text-gray-600"></div>
                    </div>
                </div>

                <!-- ローカルストレージ確認 -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-database text-orange-500 mr-2"></i>
                        ローカルストレージ
                    </h2>
                    <div class="space-y-2">
                        <button id="check-local" class="w-full bg-orange-600 text-white py-2 px-4 rounded-md hover:bg-orange-700">
                            ローカルデータを確認
                        </button>
                        <button id="clear-local" class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700">
                            ローカルデータをクリア
                        </button>
                        <div id="local-result" class="text-sm text-gray-600"></div>
                    </div>
                </div>
            </div>

            <!-- ログ表示 -->
            <div class="mt-8 bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-terminal text-gray-500 mr-2"></i>
                    ログ
                </h2>
                <div id="log-container" class="bg-gray-900 text-green-400 p-4 rounded-md font-mono text-sm max-h-64 overflow-y-auto">
                    <div>テストを開始してください...</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { supabaseService } from './js/services/supabaseService.js';

        // ログ表示関数
        function log(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : 'text-blue-400';
            logContainer.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // 接続状態をチェック
        async function checkConnection() {
            const statusDiv = document.getElementById('connection-status');
            try {
                const isAvailable = supabaseService.isAvailable();
                if (isAvailable) {
                    const isConnected = await supabaseService.checkConnection();
                    if (isConnected) {
                        statusDiv.innerHTML = `
                            <div class="flex items-center">
                                <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                                <span>Supabase接続済み</span>
                            </div>
                        `;
                        log('Supabase接続確認完了', 'success');
                    } else {
                        statusDiv.innerHTML = `
                            <div class="flex items-center">
                                <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                                <span>Supabase接続失敗</span>
                            </div>
                        `;
                        log('Supabase接続失敗', 'error');
                    }
                } else {
                    statusDiv.innerHTML = `
                        <div class="flex items-center">
                            <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                            <span>Supabase利用不可</span>
                        </div>
                    `;
                    log('Supabase利用不可', 'error');
                }
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="flex items-center">
                        <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                        <span>接続エラー: ${error.message}</span>
                    </div>
                `;
                log(`接続エラー: ${error.message}`, 'error');
            }
        }

        // 認証状態をチェック
        function checkAuth() {
            const authDiv = document.getElementById('auth-status');
            try {
                const currentUser = supabaseService.getCurrentUser();
                if (currentUser) {
                    authDiv.innerHTML = `
                        <div class="flex items-center">
                            <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                            <span>認証済み: ${currentUser.email || 'Unknown'}</span>
                        </div>
                    `;
                    log(`認証済み: ${currentUser.email || 'Unknown'}`, 'success');
                } else {
                    authDiv.innerHTML = `
                        <div class="flex items-center">
                            <span class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></span>
                            <span>未認証</span>
                        </div>
                    `;
                    log('未認証', 'info');
                }
            } catch (error) {
                authDiv.innerHTML = `
                    <div class="flex items-center">
                        <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                        <span>認証エラー: ${error.message}</span>
                    </div>
                `;
                log(`認証エラー: ${error.message}`, 'error');
            }
        }

        // テストデータを保存
        async function testSave() {
            const resultDiv = document.getElementById('save-result');
            try {
                const testData = {
                    display_name: 'テストユーザー',
                    age: 25,
                    weight: 70,
                    height: 175,
                    fitness_level: 'intermediate',
                    primary_goal: 'muscle_gain',
                    workout_frequency: 3,
                    theme_preference: 'auto'
                };

                log('テストデータを保存中...', 'info');
                const result = await supabaseService.saveUserProfile(testData);
                
                if (result) {
                    resultDiv.innerHTML = '<span class="text-green-600">✅ 保存成功（Supabase）</span>';
                    log('テストデータ保存成功（Supabase）', 'success');
                } else {
                    resultDiv.innerHTML = '<span class="text-yellow-600">⚠️ 保存成功（ローカルのみ）</span>';
                    log('テストデータ保存成功（ローカルのみ）', 'info');
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="text-red-600">❌ 保存失敗: ${error.message}</span>`;
                log(`保存失敗: ${error.message}`, 'error');
            }
        }

        // データを読み込み
        async function testLoad() {
            const resultDiv = document.getElementById('save-result');
            try {
                log('データを読み込み中...', 'info');
                const profile = await supabaseService.getUserProfile();
                
                if (profile && Object.keys(profile).length > 0) {
                    resultDiv.innerHTML = '<span class="text-green-600">✅ 読み込み成功</span>';
                    log(`データ読み込み成功: ${JSON.stringify(profile, null, 2)}`, 'success');
                } else {
                    resultDiv.innerHTML = '<span class="text-yellow-600">⚠️ データなし</span>';
                    log('データなし', 'info');
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="text-red-600">❌ 読み込み失敗: ${error.message}</span>`;
                log(`読み込み失敗: ${error.message}`, 'error');
            }
        }

        // ローカルストレージを確認
        function checkLocalStorage() {
            const resultDiv = document.getElementById('local-result');
            try {
                const userProfile = localStorage.getItem('userProfile');
                if (userProfile) {
                    const profile = JSON.parse(userProfile);
                    resultDiv.innerHTML = '<span class="text-green-600">✅ ローカルデータあり</span>';
                    log(`ローカルデータ: ${JSON.stringify(profile, null, 2)}`, 'success');
                } else {
                    resultDiv.innerHTML = '<span class="text-yellow-600">⚠️ ローカルデータなし</span>';
                    log('ローカルデータなし', 'info');
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="text-red-600">❌ エラー: ${error.message}</span>`;
                log(`ローカルストレージエラー: ${error.message}`, 'error');
            }
        }

        // ローカルストレージをクリア
        function clearLocalStorage() {
            const resultDiv = document.getElementById('local-result');
            try {
                localStorage.removeItem('userProfile');
                resultDiv.innerHTML = '<span class="text-blue-600">🗑️ ローカルデータをクリアしました</span>';
                log('ローカルデータをクリアしました', 'info');
            } catch (error) {
                resultDiv.innerHTML = `<span class="text-red-600">❌ クリア失敗: ${error.message}</span>`;
                log(`クリア失敗: ${error.message}`, 'error');
            }
        }

        // イベントリスナーを設定
        document.getElementById('test-save').addEventListener('click', testSave);
        document.getElementById('test-load').addEventListener('click', testLoad);
        document.getElementById('check-local').addEventListener('click', checkLocalStorage);
        document.getElementById('clear-local').addEventListener('click', clearLocalStorage);

        // 初期化
        log('テストページを初期化中...', 'info');
        checkConnection();
        checkAuth();
        checkLocalStorage();
    </script>
</body>
</html>
